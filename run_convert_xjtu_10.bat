@echo off
REM 优化的XJTU转换脚本 - 转换10个文件
REM 使用更新的Token: JSESSIONID=node015xfjqikf7vxkroocnnjvtonn4.node0

cd /d D:\guzhangjiance
python -c "exec(open('tools/sound_api/convert_xjtu_optimized.py', encoding='utf-8').read())" 2>nul || python -c "import sys; sys.path.insert(0, 'tools/sound_api'); exec('''import os, sys, json, shutil\nfrom pathlib import Path\nfrom tqdm import tqdm\nfrom convert_mc_to_wav import batch_convert_mc_to_wav\nfrom convert_sound_api import get_default_config, test_sound_api, parse_api_response, save_to_xlsx_format\n\n# 更新Token\napi_url, headers, params, file_param = get_default_config()\nheaders[\"Cookie\"] = \"JSESSIONID=node015xfjqikf7vxkroocnnjvtonn4.node0\"\nprint(\"Updated Token:\", headers[\"Cookie\"])\n\n# 配置\nmc_dir = r\"D:\\\\guzhangjiance\\\\datasets\\\\output_xjtu_mc\\\\xjtu\"\nwav_dir = r\"D:\\\\guzhangjiance\\\\datasets\\\\output_xjtu_mc\\\\wav_temp\"\napi_dir = r\"D:\\\\guzhangjiance\\\\tools\\\\sound_api\\\\sound_api_output\"\nos.makedirs(wav_dir, exist_ok=True)\nos.makedirs(api_dir, exist_ok=True)\n\n# 获取前10个文件\nmc_path = Path(mc_dir)\nall_files = sorted(list(mc_path.glob(\"XJTU-SY_*.f\")))[:10]\nprint(f\"\\n将处理 {len(all_files)} 个文件\")\n\n# 检查已转换的文件\nskip_count = 0\nfiles_to_convert = []\nfor f in all_files:\n    name = f.stem\n    json_file = os.path.join(api_dir, f\"{name}.json\")\n    xlsx_file = os.path.join(api_dir, f\"{name}.xlsx\")\n    if os.path.exists(json_file) and os.path.exists(xlsx_file):\n        skip_count += 1\n        print(f\"  跳过已转换: {name}\")\n    else:\n        files_to_convert.append(f)\n\nprint(f\"需要转换: {len(files_to_convert)} 个文件（跳过 {skip_count} 个）\")\n\nif len(files_to_convert) == 0:\n    print(\"\\n所有文件都已转换完成！\")\n    exit(0)\n\n# 创建临时目录\ntemp_dir = os.path.join(wav_dir, \"temp_mc\")\nos.makedirs(temp_dir, exist_ok=True)\nfor f in files_to_convert:\n    shutil.copy2(f, os.path.join(temp_dir, f.name))\n    json_f = f.with_suffix(\".json\")\n    if json_f.exists():\n        shutil.copy2(json_f, os.path.join(temp_dir, json_f.name))\n\n# MC转WAV\nprint(\"\\n[1] MC -> WAV\")\nresult1 = batch_convert_mc_to_wav(temp_dir, wav_dir, \"horizontal\", \"minmax\")\nprint(f\"成功: {result1[\\\"success\\\"]}\")\n\n# WAV转API\nprint(\"\\n[2] WAV -> API\")\nwav_files = [item[\\\"output\\\"] for item in result1[\\\"files\\\"] if item.get(\\\"status\\\") == \\\"success\\\" and \\\"output\\\" in item]\n\nresults = []\nfor wav in tqdm(wav_files, desc=\"API转换\"):\n    name = os.path.splitext(os.path.basename(wav))[0]\n    r = test_sound_api(wav, api_url, headers, file_param, params, timeout=60)\n    if r:\n        data = parse_api_response(r, False)\n        if data:\n            json_file = os.path.join(api_dir, f\"{name}.json\")\n            with open(json_file, \"w\", encoding=\"utf-8\") as f:\n                json.dump({\"frequency\": data[\\\"frequency\\\"].tolist(), \"volume\": data[\\\"volume\\\"].tolist(), \"density\": data[\\\"density\\\"].tolist()}, f, indent=2, ensure_ascii=False)\n            xlsx_file = os.path.join(api_dir, f\"{name}.xlsx\")\n            save_to_xlsx_format(data, xlsx_file, name)\n            results.append({\"name\": name, \"data\": data})\n            # 清理WAV文件\n            try:\n                os.remove(wav)\n            except:\n                pass\n\nprint(f\"\\n转换完成: 成功 {len(results)} 个文件\")\n\n# 清理临时目录\nshutil.rmtree(temp_dir, ignore_errors=True)\nprint(\"\\n完成！\")\n''')"

pause
